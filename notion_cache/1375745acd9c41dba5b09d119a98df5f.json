{
  "ID": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
  "Page": {
    "alive": true,
    "content": [
      "326f6305-1cf7-4828-bb85-7ff0c22ba797",
      "783ecc70-f042-48dc-951c-74ff6b502fc5",
      "d8cf27f3-6f9e-452e-bebf-9c65265c95f4",
      "1b5864a6-f85c-4dc7-a05e-d079b3fac054",
      "727da785-e942-4a54-9add-d78b174bd67e",
      "5b4d07d4-5384-4753-9c06-77b97f982d0c",
      "350d7623-fa93-49ad-ae39-a7b1f8db3d1a",
      "bdf3fdb6-59e4-4dc9-83b1-3ab14603b1ec",
      "25e69eef-4945-492e-aa8a-29dc9a0fa364",
      "32c5e0b0-614d-4011-b05f-63bbedd9beb9",
      "62525403-dd15-4c2b-8c0c-6db0b6593784",
      "568fbd4b-3331-4e51-8ca8-8e5a925353bb",
      "d47563ba-115d-4fcf-a174-dbf31a5ef4bf",
      "f98dea76-cd69-4c5a-90b5-e79e16c73ee2",
      "b7e19fc3-ecc1-49a5-abc4-87f74e66df1b",
      "612107a2-3d5e-47b0-a344-dbc5836fdfe7",
      "435f7a57-f51c-469b-8bfd-c67b2d0bd9fa",
      "56c0fe5d-c0a2-496b-ae97-25bacfd08242",
      "917c14df-912c-4c70-8b70-41a907c49942",
      "04a91c93-978f-4e73-a0b0-260d6e4fd0e8",
      "f926221f-9877-422a-af3c-f775c63541eb"
    ],
    "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
    "created_time": 1531195944446,
    "format": {
      "page_full_width": true,
      "page_small_text": true
    },
    "id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
    "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
    "last_edited_time": 1531623568594,
    "parent_id": "300db9dc-27c8-4958-a08b-8d0c37f4cfe5",
    "parent_table": "block",
    "properties": {
      "title": [
        [
          "Compacting s3 aws logs"
        ]
      ]
    },
    "type": "page",
    "version": 7,
    "content_resolved": [
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "326f6305-1cf7-4828-bb85-7ff0c22ba797",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531623568594,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Id: 12012"
            ]
          ]
        },
        "type": "text",
        "version": 3,
        "inline_content": [
          {
            "Text": "Id: 12012"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "783ecc70-f042-48dc-951c-74ff6b502fc5",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Tags: aws, python"
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "Tags: aws, python"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "d8cf27f3-6f9e-452e-bebf-9c65265c95f4",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Date: 2009-03-07T18:39:07-08:00"
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "Date: 2009-03-07T18:39:07-08:00"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "1b5864a6-f85c-4dc7-a05e-d079b3fac054",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531623567147,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "type": "text",
        "version": 3
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "727da785-e942-4a54-9add-d78b174bd67e",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Amazon’s s3 can serve the files via HTTP protocol, so it can be used as an HTTP server for static files. With a little effort you can configure a given s3 bucket to save access log files to a different s3 bucket. This is useful if you’re interested e.g. in figuring out how often a given file is being downloaded. Logging doesn’t happen automatically. To set it up, carefully follow "
            ],
            [
              "this official document",
              [
                [
                  "a",
                  "http://docs.amazonwebservices.com/AmazonS3/latest/index.html?ServerLogs.html"
                ]
              ]
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "Amazon’s s3 can serve the files via HTTP protocol, so it can be used as an HTTP server for static files. With a little effort you can configure a given s3 bucket to save access log files to a different s3 bucket. This is useful if you’re interested e.g. in figuring out how often a given file is being downloaded. Logging doesn’t happen automatically. To set it up, carefully follow "
          },
          {
            "Text": "this official document",
            "Link": "http://docs.amazonwebservices.com/AmazonS3/latest/index.html?ServerLogs.html"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "5b4d07d4-5384-4753-9c06-77b97f982d0c",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Unfortunately, standard s3 logs have a problem: they’re split among lots of files. Around 200 log files are generated for one day which leads to enormous number of files stored on s3 (e.g. merely 6 months of logs generated ~35k of log files)."
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "Unfortunately, standard s3 logs have a problem: they’re split among lots of files. Around 200 log files are generated for one day which leads to enormous number of files stored on s3 (e.g. merely 6 months of logs generated ~35k of log files)."
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "350d7623-fa93-49ad-ae39-a7b1f8db3d1a",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "To fix that I wrote a python script that compacts the logs so that we only get one file per day, which is a more reasonable number (35k files shrank to only 171 for me). As a bonus, it also compresses the log. Given very repetitive nature of log files, it’s a big win (the file shrinks by 94% when compressed with bzip2 algorithm)."
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "To fix that I wrote a python script that compacts the logs so that we only get one file per day, which is a more reasonable number (35k files shrank to only 171 for me). As a bonus, it also compresses the log. Given very repetitive nature of log files, it’s a big win (the file shrinks by 94% when compressed with bzip2 algorithm)."
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "bdf3fdb6-59e4-4dc9-83b1-3ab14603b1ec",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "The logic of the script is simple:"
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "The logic of the script is simple:"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "25e69eef-4945-492e-aa8a-29dc9a0fa364",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "download all the files for a given day locally"
            ]
          ]
        },
        "type": "bulleted_list",
        "version": 1,
        "inline_content": [
          {
            "Text": "download all the files for a given day locally"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "32c5e0b0-614d-4011-b05f-63bbedd9beb9",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "create one file that is compressed concatenation of those files"
            ]
          ]
        },
        "type": "bulleted_list",
        "version": 1,
        "inline_content": [
          {
            "Text": "create one file that is compressed concatenation of those files"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "62525403-dd15-4c2b-8c0c-6db0b6593784",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "upload compressed file back to s3"
            ]
          ]
        },
        "type": "bulleted_list",
        "version": 1,
        "inline_content": [
          {
            "Text": "upload compressed file back to s3"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "568fbd4b-3331-4e51-8ca8-8e5a925353bb",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "delete the original files"
            ]
          ]
        },
        "type": "bulleted_list",
        "version": 1,
        "inline_content": [
          {
            "Text": "delete the original files"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "d47563ba-115d-4fcf-a174-dbf31a5ef4bf",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "repeat"
            ]
          ]
        },
        "type": "bulleted_list",
        "version": 1,
        "inline_content": [
          {
            "Text": "repeat"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "f98dea76-cd69-4c5a-90b5-e79e16c73ee2",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "It took me a few hours to get right, so in the spirit of sharing, "
            ],
            [
              "here it is",
              [
                [
                  "a",
                  "http://code.google.com/p/kjk/source/browse/trunk/scripts/compact-s3-logs.py"
                ]
              ]
            ],
            [
              ". You’ll have to change a few things in the source:"
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "It took me a few hours to get right, so in the spirit of sharing, "
          },
          {
            "Text": "here it is",
            "Link": "http://code.google.com/p/kjk/source/browse/trunk/scripts/compact-s3-logs.py"
          },
          {
            "Text": ". You’ll have to change a few things in the source:"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "b7e19fc3-ecc1-49a5-abc4-87f74e66df1b",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "s3 bucket name that stores the logs"
            ]
          ]
        },
        "type": "bulleted_list",
        "version": 1,
        "inline_content": [
          {
            "Text": "s3 bucket name that stores the logs"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "612107a2-3d5e-47b0-a344-dbc5836fdfe7",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "where the logs are downloaded locally. I preserve them although they could be deleted if you’re short on space"
            ]
          ]
        },
        "type": "bulleted_list",
        "version": 1,
        "inline_content": [
          {
            "Text": "where the logs are downloaded locally. I preserve them although they could be deleted if you’re short on space"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "435f7a57-f51c-469b-8bfd-c67b2d0bd9fa",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Also, the script expects a "
            ],
            [
              "awscreds.py",
              [
                [
                  "c"
                ]
              ]
            ],
            [
              " file with access/secret key i.e.:"
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "Also, the script expects a "
          },
          {
            "Text": "awscreds.py",
            "AttrFlags": 2
          },
          {
            "Text": " file with access/secret key i.e.:"
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "56c0fe5d-c0a2-496b-ae97-25bacfd08242",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "language": [
            [
              "Plain Text"
            ]
          ],
          "title": [
            [
              "access = “access key”\n    secret = “secret key”"
            ]
          ]
        },
        "type": "code",
        "version": 1,
        "code": "access = “access key”\n    secret = “secret key”",
        "code_language": "Plain Text"
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "917c14df-912c-4c70-8b70-41a907c49942",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "One unexpected thing I noticed is that apparently Amazon sometimes saves the log file with screwy permissions so that it can’t be read or even fixed by setting new acl (both those operations return 403 forbidden). The only operation that works is deleting the file from s3, so that’s what I do (it’s only a log file, after all)."
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "One unexpected thing I noticed is that apparently Amazon sometimes saves the log file with screwy permissions so that it can’t be read or even fixed by setting new acl (both those operations return 403 forbidden). The only operation that works is deleting the file from s3, so that’s what I do (it’s only a log file, after all)."
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944446,
        "id": "04a91c93-978f-4e73-a0b0-260d6e4fd0e8",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944446,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Another thing I noticed is that boto sometimes hangs when talking to s3 (exception on timeout would be much better). If that happens, you can kill the script and restart it - it’s smart enough to not re-download files and only deletes the original log files on s3 after compressed log has been saved in s3."
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "Another thing I noticed is that boto sometimes hangs when talking to s3 (exception on timeout would be much better). If that happens, you can kill the script and restart it - it’s smart enough to not re-download files and only deletes the original log files on s3 after compressed log has been saved in s3."
          }
        ]
      },
      {
        "alive": true,
        "created_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "created_time": 1531195944447,
        "id": "f926221f-9877-422a-af3c-f775c63541eb",
        "last_edited_by": "bb760e2d-d679-4b64-b2a9-03005b21870a",
        "last_edited_time": 1531195944447,
        "parent_id": "1375745a-cd9c-41db-a5b0-9d119a98df5f",
        "parent_table": "block",
        "properties": {
          "title": [
            [
              "Expected usage of the script is as a daily script followed by a script that analyzes the logs. Due to boto hanging it might not work well in such scenario, though."
            ]
          ]
        },
        "type": "text",
        "version": 1,
        "inline_content": [
          {
            "Text": "Expected usage of the script is as a daily script followed by a script that analyzes the logs. Due to boto hanging it might not work well in such scenario, though."
          }
        ]
      }
    ],
    "title": "Compacting s3 aws logs",
    "format_page": {
      "page_cover": "",
      "page_cover_position": 0,
      "page_font": "",
      "page_full_width": true,
      "page_icon": "",
      "page_small_text": true
    }
  },
  "Users": [
    {
      "email": "kkowalczyk@gmail.com",
      "family_name": "Kowalczyk",
      "given_name": "Krzysztof",
      "id": "bb760e2d-d679-4b64-b2a9-03005b21870a",
      "locale": "en",
      "mobile_onboarding_completed": true,
      "onboarding_completed": true,
      "profile_photo": "https://s3-us-west-2.amazonaws.com/public.notion-static.com/2dcaa66c-7674-4ff6-9924-601785b63561/head-bw-640x960.png",
      "time_zone": "America/Los_Angeles",
      "version": 9
    }
  ],
  "Collections": null,
  "CollectionViews": null
}